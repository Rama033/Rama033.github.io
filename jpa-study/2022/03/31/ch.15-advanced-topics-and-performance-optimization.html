<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>[자바 ORM 표준 JPA 프로그래밍] 15장. 고급 주제와 성능 최적화</title>
  <meta name="description" content="15장. 고급 주제와 성능 최적화">
  
  <meta name="author" content="Jo">
  <meta name="copyright" content="&copy; Jo 2022">
  

  <!-- External libraries -->
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/monokai-sublime.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.7.1/css/lightbox.css">

  <!-- Favicon and other icons (made with http://www.favicon-generator.org/) -->
  <link rel="shortcut icon" href="/assets/icons/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/assets/icons/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" sizes="57x57" href="/assets/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/assets/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/assets/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/assets/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/assets/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/assets/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/assets/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/assets/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/assets/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/assets/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png">
  <link rel="manifest" href="/assets/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/assets/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  
  <!-- Facebook OGP cards -->
  <meta property="og:description" content="15장. 고급 주제와 성능 최적화" />
  <meta property="og:url" content="https://sungunjo.github.io/jpa-study/2022/03/31/ch.15-advanced-topics-and-performance-optimization.html">
  <meta property="og:site_name" content="Development Stash" />
  <meta property="og:title" content="[자바 ORM 표준 JPA 프로그래밍] 15장. 고급 주제와 성능 최적화" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://sungunjo.github.io/assets/instacode.png" />
  <meta property="og:image:type" content="image/png" />
  <meta property="og:image:width" content="612" />
  <meta property="og:image:height" content="605" />
  

  
  <!-- Twitter: card tags -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="[자바 ORM 표준 JPA 프로그래밍] 15장. 고급 주제와 성능 최적화">
  <meta name="twitter:description" content="15장. 고급 주제와 성능 최적화">
  <meta name="twitter:image" content="https://sungunjo.github.io/assets/instacode.png">
  <meta name="twitter:url" content="https://sungunjo.github.io/jpa-study/2022/03/31/ch.15-advanced-topics-and-performance-optimization.html">
  

  

  <!-- Site styles -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://sungunjo.github.io/jpa-study/2022/03/31/ch.15-advanced-topics-and-performance-optimization.html">
	<link rel="alternate" type="application/rss+xml" title="Development Stash" href="https://sungunjo.github.io/feed.xml" />
	
	<!-- Tooltips -->
	<script type="text/javascript">
		window.tooltips = []
	</script>
</head>


  <body>

    <header class="navigation" role="banner">
  <div class="navigation-wrapper">
    <a href="/" class="logo">
      
      <img src="/assets/logo.png" alt="Development Stash">
      
    </a>
    <a href="javascript:void(0)" class="navigation-menu-button" id="js-mobile-menu">
      <i class="fa fa-bars"></i>
    </a>
    <nav role="navigation">
      <ul id="js-navigation-menu" class="navigation-menu show">
				
	
	<li class="nav-link"><a href="/about/">About</a>
	

	

	

	
	<li class="nav-link"><a href="/posts/">Posts</a>
	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	


      </ul>
    </nav>
  </div>
</header>


    <div class="page-content">
        <div class="post">

<div class="post-header-container has-cover" style="background-image: url(/assets/instacode.png);">
  <div class="scrim has-cover">
    <header class="post-header">
      <h1 class="title">[자바 ORM 표준 JPA 프로그래밍] 15장. 고급 주제와 성능 최적화</h1>
      <p class="info">by <strong>Jo</strong></p>
    </header>
  </div>
</div>

<div class="wrapper">



<section class="post-meta">
  <div class="post-date">March 31, 2022</div>
  <div class="post-categories">
  in 
    
    <a href="/category/jpa-study">Jpa-study</a>
    
  
  </div>
</section>

<article class="post-content">
  <h1 id="15장-고급-주제와-성능-최적화">15장. 고급 주제와 성능 최적화</h1>

<p><br /></p>

<h1 id="151-예외-처리">15.1 예외 처리</h1>

<p><br /></p>

<h2 id="1511-jpa-표준-예외-정리">15.1.1 JPA 표준 예외 정리</h2>
<ul>
  <li><code class="language-plaintext highlighter-rouge">RuntimeException</code>
    <ul>
      <li>ㄴ <code class="language-plaintext highlighter-rouge">javax.persistence.PersistenceException</code>
        <ul>
          <li>ㄴ JPA 표준 예외
            <ul>
              <li>트랜잭션 롤백을 표시하는 예외
                <ul>
                  <li>심각한 예외, 복구 X</li>
                  <li>트랜잭션 강제 커밋해도 안먹히고 <code class="language-plaintext highlighter-rouge">javax.persistence.RollbackException</code> 발생</li>
                </ul>
              </li>
              <li>트랜잭션 롤백을 표시하지 않는 예외
                <ul>
                  <li>심각하지 않은 예외</li>
                  <li>개발자가 커밋, 롤백 여부 판단해서 선택</li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<table>
  <thead>
    <tr>
      <th style="text-align: left">트랜잭션 롤백을 표시하는 예외</th>
      <th style="text-align: left">설명</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">javax.persistence.EntityExistsException</td>
      <td style="text-align: left">EntityManager.persist(…) 호출 시 이미 같은 엔티티 있는 경우</td>
    </tr>
    <tr>
      <td style="text-align: left">javax.persistence.EntityNotFoundException</td>
      <td style="text-align: left">EntityManager.getReference(…) 호출했는데 실제 사용 시 엔티티가 존재하지 않으면 발생<br />refresh(…), lock(…) 에서도 발생함</td>
    </tr>
    <tr>
      <td style="text-align: left">javax.persistence.OptimisticLockException</td>
      <td style="text-align: left">낙관적 락 충돌 시 발생</td>
    </tr>
    <tr>
      <td style="text-align: left">javax.persistence.PessimisticLockException</td>
      <td style="text-align: left">비관적 락 충돌 시 발생</td>
    </tr>
    <tr>
      <td style="text-align: left">javax.persistence.RollbackException</td>
      <td style="text-align: left">EntityTranscation.commit() 실패 시 발생<br />롤백 표시되어 있는 트랜잭션 커밋 시에도 발생함</td>
    </tr>
    <tr>
      <td style="text-align: left">javax.persistence.TranscationRequiredException</td>
      <td style="text-align: left">트랜잭션 필요할 때 없으면 발생<br /> 트랜잭션 없이 엔티티 변경 시 주로 발생함</td>
    </tr>
  </tbody>
</table>

<p><br /></p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">트랜잭션 롤백을 표시하지 않는 예외</th>
      <th style="text-align: left">설명</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">javax.persistence.NoResultException</td>
      <td style="text-align: left">Query.getSingleResult() 호출 시 결과 하나도 없으면 발생</td>
    </tr>
    <tr>
      <td style="text-align: left">javax.persistence.NonUniqueResultException</td>
      <td style="text-align: left">Query.getSingleResult() 호출 시 결과 둘 이상이면 발생</td>
    </tr>
    <tr>
      <td style="text-align: left">javax.persistence.LockTimeoutException</td>
      <td style="text-align: left">비관적 락에서 시간 초과 시 발생</td>
    </tr>
    <tr>
      <td style="text-align: left">javax.persistence.QueryTimeoutException</td>
      <td style="text-align: left">쿼리 실행 시간 초과 시 발생</td>
    </tr>
  </tbody>
</table>

<p><br />
<br /></p>

<h2 id="1512-스프링-프레임워크의-jpa-예외-변환">15.1.2 스프링 프레임워크의 JPA 예외 변환</h2>
<ul>
  <li>서비스 레이어에서 데이터 엑세스 레이어 구현 기술에 의존하는건 좋은 설계 아님</li>
  <li>예외도 마찬가지로 서비스 레이어에서 JPA 예외 직접 사용해 JPA 에 의존하게 되는건 좋지 않음</li>
  <li>이를 해결하기 위해 스프링에선 데이터 엑세스 레이어에 대한 예외를 추상화해서 제공해주고 있음</li>
</ul>

<table>
  <thead>
    <tr>
      <th style="text-align: left">JPA 예외</th>
      <th style="text-align: left">스프링 변환 예외</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">javax.persistence.PersistenceException</td>
      <td style="text-align: left">org.springframework.orm.jpa.JpaSystemException</td>
    </tr>
    <tr>
      <td style="text-align: left">javax.persistence.NoResultException</td>
      <td style="text-align: left">org.springframework.dao.EmptyResultDataAccessException</td>
    </tr>
    <tr>
      <td style="text-align: left">javax.persistence.NonUniqueResultException</td>
      <td style="text-align: left">org.springframework.dao.EmptyResultDataAccessException</td>
    </tr>
    <tr>
      <td style="text-align: left">javax.persistence.LockTimeoutException</td>
      <td style="text-align: left">org.springframework.dao.CannotAcquireLockException</td>
    </tr>
    <tr>
      <td style="text-align: left">javax.persistence.QueryTimeoutException</td>
      <td style="text-align: left">org.springframework.dao.QueryTimeoutException</td>
    </tr>
    <tr>
      <td style="text-align: left">javax.persistence.EntityExistsException</td>
      <td style="text-align: left">org.springframework.dao.DataIntegrityViolationException</td>
    </tr>
    <tr>
      <td style="text-align: left">javax.persistence.EntityNotFoundException</td>
      <td style="text-align: left">org.springframework.dao.JpaObjectRetrievalFailureException</td>
    </tr>
    <tr>
      <td style="text-align: left">javax.persistence.OptimisticLockException</td>
      <td style="text-align: left">org.springframework.dao.JpaOptimisticLockingFailureException</td>
    </tr>
    <tr>
      <td style="text-align: left">javax.persistence.PessimisticLockException</td>
      <td style="text-align: left">org.springframework.dao.PessimisticLockingFailureException</td>
    </tr>
    <tr>
      <td style="text-align: left">javax.persistence.TransactionRequiredException</td>
      <td style="text-align: left">org.springframework.dao.InvalidDataAccessApiUsageException</td>
    </tr>
    <tr>
      <td style="text-align: left">javax.persistence.RollbackException</td>
      <td style="text-align: left">org.springframework.dao.TRansactionSystemException</td>
    </tr>
    <tr>
      <td style="text-align: left">javax.persistence.IllegalStateException</td>
      <td style="text-align: left">org.springframework.dao.InvalidDataACcessApiUsageException</td>
    </tr>
    <tr>
      <td style="text-align: left">javax.persistence.IllegalArgumnentException</td>
      <td style="text-align: left">org.springframework.dao.InvalidDataAccessApiUsageException</td>
    </tr>
  </tbody>
</table>

<p><br />
<br /></p>

<h2 id="1513-스프링-프레임워크에-jpa-예외-변환기-적용">15.1.3 스프링 프레임워크에 JPA 예외 변환기 적용</h2>
<ul>
  <li><code class="language-plaintext highlighter-rouge">PersistenceExceptionTranslationPostProcessor</code> 를 스프링 빈으로 등록하여 JPA 예외 -&gt; 스프링 예외 변환 기능 사용 가능</li>
  <li><code class="language-plaintext highlighter-rouge">@Repository</code> 어노테이션 사용한 곳에 예외 변환 AOP 적용해서 JPA 예외를 스프링 프레임워크의 추상화한 예외로 변환해줌</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- xml로 설정 --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"org.springframework.dao.annotation.PersistenceExceptionTranslactionPostProcessor"</span> <span class="nt">/&gt;</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// JavaConfig으로 설정</span>
<span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">PersistenceExceptionTranslationPostProcessor</span> <span class="nf">exceptionTranslation</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">PersistenceExceptionTranslationPostProcessor</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 예외 변환 예제</span>
<span class="nd">@Repostiroy</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NoResultExceptionTestRepository</span> <span class="o">{</span>
    <span class="nd">@PersistnceContext</span> <span class="nc">EntityManger</span> <span class="n">em</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">Member</span> <span class="nf">findMember</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// 조회된 member 없음</span>
        <span class="k">return</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"SELECT m FROM Member m"</span><span class="o">,</span> <span class="nc">Member</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getSingleResult</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ol>
  <li><code class="language-plaintext highlighter-rouge">getSingleResult()</code> 메소드 호출</li>
  <li>조회된 결과 없어서 <code class="language-plaintext highlighter-rouge">javax.persistence.NoResultException</code> 발생</li>
  <li><code class="language-plaintext highlighter-rouge">PersistenceExceptionTranslationPostProcessor</code> 에서 등록한 AOP 인터셉터가 동작해 해당 예외를 <code class="language-plaintext highlighter-rouge">org.springframework.dao.EmptyResultDatAcessExcetpion</code> 으로 변환해서 리턴</li>
</ol>

<ul>
  <li>예외 변환하지 않고 그대로 반환하려면 throws 절에 그대로 반환할 JPA 예외나 JPA 예외의 부모 클래스를 직접 명시
    <ul>
      <li><code class="language-plaintext highlighter-rouge">public member findMember() throws javax.persistence.NoResultException {    // NoResultException 은 변환하지 않고 리턴함</code></li>
    </ul>
  </li>
</ul>

<p><br />
<br /></p>

<h2 id="1514-트랜잭션-롤백-시-주의사항">15.1.4 트랜잭션 롤백 시 주의사항</h2>
<ul>
  <li>트랜잭션 롤백은 DB 반영사항만 롤백, 수정한 자바 객체는 원상태 복구 안해줌
    <ul>
      <li>DB 데이터는 원래대로 돌아가도 엔티티 객체는 수정된 상태로 영속성 컨텍스트에 남음</li>
    </ul>
  </li>
  <li>∴ 새로운 영속성 컨텍스트 생성하거나 <code class="language-plaintext highlighter-rouge">EntityManager.clear()</code> 호출해서 초기화한 다음 사용해야 함</li>
  <li>스프링 프레임워크는 이런 문제 예방을 위해 영속성 컨텍스트 범위에 따라 다른 방법을 사용
    <ul>
      <li>트랜잭션당 영속성 컨텍스트 전략
        <ul>
          <li>문제 발생시 트랜잭션 AOP 종료 시점에 트랜잭션 롤백 되며 영속성 컨텍스트도 종료되어 문제 없음</li>
        </ul>
      </li>
      <li>OSIV 처럼 영속성 컨텍스트 범위를 트랜잭션 범위보다 넒게 사용해 여러 트랜잭션이 하나의 영속성 컨텍스트 사용하는 경우
        <ul>
          <li>트랜잭션 롤백해서 영속성 컨텍스트 이상 발생해도 다른 트랜잭션이 해당 영속성 컨텍스트 그대로 사용하게 되는 문제 있음</li>
          <li>스프링에서는 영속성 컨텍스트 범위를 트랜잭션 보다 넓게 설정하면 트랜잭션 롤백 시 <code class="language-plaintext highlighter-rouge">EntityManager.clear()</code> 로 영속성 컨텍스트 초기화 시켜서 문제 예방함</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p><br />
<br />
<br /></p>

<h1 id="152-엔티티-비교">15.2 엔티티 비교</h1>
<ul>
  <li><strong>애플리케이션 수준의 반복 가능한 읽기</strong>
    <ul>
      <li>1차 캐시의 가장 큰 장점</li>
      <li>같은 영속성 컨텍스트에서 엔티티 조회 시 항상 같은 엔티티 인스턴스를 반환</li>
    </ul>
  </li>
</ul>

<p><br />
<br /></p>

<h2 id="1521-영속성-컨텍스트가-같을-때-엔티티-비교">15.2.1 영속성 컨텍스트가 같을 때 엔티티 비교</h2>

<p><img src="/assets/img/jpa_study/ch.15/pic-15-1.png" /></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 회원가입 테스트 케이스에서의 테스트와 트랜잭션 범위 예제</span>
<span class="nd">@RunWith</span><span class="o">(</span><span class="nc">SpringJUnit4ClassRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@ContextConfiguration</span><span class="o">(</span><span class="n">locations</span> <span class="o">=</span> <span class="s">"classpath:appConfig.xml"</span><span class="o">)</span>
<span class="nd">@Transactional</span>  <span class="c1">// 트랜잭션 안에서 테스트를 실행</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberServiceTest</span> <span class="o">{</span>
    <span class="nd">@Autowired</span> <span class="nc">MemberService</span> <span class="n">memberService</span><span class="o">;</span>
    <span class="nd">@Autowired</span> <span class="nc">MemberRepsotiroy</span> <span class="n">memberRepository</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">joinTest</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="c1">// Given</span>
        <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Member</span><span class="o">(</span><span class="s">"kim"</span><span class="o">);</span>

        <span class="c1">// When</span>
        <span class="nc">Long</span> <span class="n">saveId</span> <span class="o">=</span> <span class="n">memberService</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="n">member</span><span class="o">);</span>

        <span class="c1">// Then</span>
        <span class="nc">Member</span> <span class="n">findMember</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">saveId</span><span class="o">)</span>
        <span class="n">asertTrue</span><span class="o">(</span><span class="n">member</span> <span class="o">==</span> <span class="n">findMember</span><span class="o">);</span>    <span class="c1">// 참조값 비교</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="o">...</span>

<span class="nd">@Transactional</span>  <span class="c1">// 이 예제에서는 Test 클래스에서 Transaction 시작해서 그거 이어받아서 사용함</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberService</span> <span class="o">{</span>
    <span class="nd">@Autowired</span> <span class="nc">MemberRepository</span> <span class="n">memberRepository</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">Long</span> <span class="nf">join</span><span class="o">(</span><span class="nc">Member</span> <span class="n">member</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>

        <span class="n">memberRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">member</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">member</span><span class="o">.</span><span class="na">getId</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="o">...</span>

<span class="nd">@Repository</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberRepository</span> <span class="o">{</span>
    <span class="nd">@PersistenceContext</span>
    <span class="nc">EntityManager</span> <span class="n">em</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">save</span><span class="o">(</span><span class="nc">Member</span> <span class="n">member</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">em</span><span class="o">.</span><span class="na">persist</span><span class="o">(</span><span class="n">member</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Member</span> <span class="nf">findOne</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">em</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="nc">Member</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><img src="/assets/img/jpa_study/ch.15/pic-15-2.png" /></p>

<ul>
  <li>테스트 클래스에 <code class="language-plaintext highlighter-rouge">@Transactional</code> 선언되어 있으면 트랜잭션 먼저 시작 후 테스트 메소드 실행되므로 <code class="language-plaintext highlighter-rouge">joinTest()</code> 메소드는 트랜잭션 범위의 안쪽, 해당 메소드 끝나면 트랜잭션 종료됨
    <ul>
      <li>테스트 클래스에 <code class="language-plaintext highlighter-rouge">@Transactional</code> 적용하면 테스트 끝날 때 트랜잭션 강제 롤백함</li>
    </ul>
  </li>
  <li>∴ <code class="language-plaintext highlighter-rouge">joinTest()</code> 에서 사용된 코드는 항상 같은 트랜잭션, 같은 영속성 컨텍스트에 접근
    <ul>
      <li>위 예제에서 저장한 member와 레포지토리에서 조회해온 엔티티가 완전히 같은 인스턴스 =&gt; 같은 트랜잭션 범위 안이라 동일한 영속성 컨텍스트를 사용하기 때문</li>
    </ul>
  </li>
  <li>영속성 컨텍스트가 같으면 엔티티 비교시 다음 3가지 조건 모두 만족함
    <ul>
      <li><strong>동일성 identical:</strong> <code class="language-plaintext highlighter-rouge">==</code> 비교가 같음</li>
      <li><strong>동등성 equinalent:</strong> <code class="language-plaintext highlighter-rouge">equals()</code> 비교가 같음</li>
      <li><strong>DB 동등성:</strong> <code class="language-plaintext highlighter-rouge">@Id</code> 인 DB 식별자가 같음</li>
    </ul>
  </li>
</ul>

<p><br />
<br /></p>

<h2 id="1522-영속성-컨텍스트가-다를-때-엔티티-비교">15.2.2 영속성 컨텍스트가 다를 때 엔티티 비교</h2>

<p><img src="/assets/img/jpa_study/ch.15/pic-15-3.png" /></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RunWith</span><span class="o">(</span><span class="nc">SpringJUnit4ClassRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@ContextConfiguration</span><span class="o">(</span><span class="n">locations</span> <span class="o">=</span> <span class="s">"classpath:appConfig.xml"</span><span class="o">)</span>
<span class="c1">// @Transcational   테스트에서 트랜잭션 사용 안함</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberServiceTest</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="nc">MemberService</span> <span class="n">memberService</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="nc">MemberRepsotiroy</span> <span class="n">memberRepository</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">joinTest</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="c1">// Given</span>
        <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Member</span><span class="o">(</span><span class="s">"kim"</span><span class="o">);</span>

        <span class="c1">// When</span>
        <span class="nc">Long</span> <span class="n">saveId</span> <span class="o">=</span> <span class="n">memberService</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="n">member</span><span class="o">);</span>

        <span class="c1">// Then</span>
        <span class="nc">Member</span> <span class="n">findMember</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">saveId</span><span class="o">)</span>    <span class="c1">// Transaction은 MemberRepository::findOne 종료되며 같이 끝났기 때문에 findMember 는 준영속 상태</span>
        <span class="n">asertTrue</span><span class="o">(</span><span class="n">member</span> <span class="o">==</span> <span class="n">findMember</span><span class="o">);</span>    <span class="c1">// member 와 findMEmber 는 다른 주소값을 가진 인스턴스 =&gt; 테스트 실패</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="o">...</span>

<span class="nd">@Transactional</span>  <span class="c1">// 서비스 클래스에서 트랜잭션이 시작됨</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberService</span> <span class="o">{</span>
    <span class="nd">@Autowired</span> <span class="nc">MemberRepository</span> <span class="n">memberRepository</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">Long</span> <span class="nf">join</span><span class="o">(</span><span class="nc">Member</span> <span class="n">member</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>

        <span class="n">memberRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">member</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">member</span><span class="o">.</span><span class="na">getId</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="o">...</span>

<span class="nd">@Repository</span>
<span class="nd">@Transactional</span>  <span class="c1">// 이 예제에서는 Test 클래스에서 트랜잭션 시작 안하기 때문에 여기도 추가</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberRepository</span> <span class="o">{</span>
    <span class="nd">@PersistenceContext</span>
    <span class="nc">EntityManager</span> <span class="n">em</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">save</span><span class="o">(</span><span class="nc">Member</span> <span class="n">member</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">em</span><span class="o">.</span><span class="na">persist</span><span class="o">(</span><span class="n">member</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Member</span> <span class="nf">findOne</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">em</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="nc">Member</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></div></div>

<p><img src="/assets/img/jpa_study/ch.15/pic-15-4.png" /></p>

<ol>
  <li>Test 코드에서 <code class="language-plaintext highlighter-rouge">memberService.join(member)</code> 호출, 회원가입 시도하면 서비스 레이어에서 트랜잭션 시작, <em>영속성 컨텍스트 1</em> 생성됨</li>
  <li><code class="language-plaintext highlighter-rouge">memberRepsitory</code> 에서 <code class="language-plaintext highlighter-rouge">em.persist()</code> 호출해서 member 엔티티 영속화</li>
  <li>서비스 레이어 끝날 때 트랜잭션 커밋되며 영속성 컨텍스트 플러시 되고 트랜잭션, 영속성 컨텍스트 종료. member 엔티티 인스턴스는 준영속 상태 됨</li>
  <li>테스트 코드에서 <code class="language-plaintext highlighter-rouge">memberRepository.findOne(saveId)</code> 호출해 저장한 엔티티 조회하면 레포지토리 레이어에서 새로운 트랜잭션 시작, <em>영속성 컨텍스트 2</em> 생성됨</li>
  <li>저장된 member 조회하지만 <em>영속성 컨텍스트 2</em> 에는 해당 member 없음</li>
  <li>DB 에서 해당 member 조회해 옴</li>
  <li>DB 에서 조회된 member 엔티티를 영속성 컨텍스트에 보관하고 반환</li>
  <li><code class="language-plaintext highlighter-rouge">memberRepository.findOne()</code> 메소드 끝나며 트랜잭션 종료, <em>영속성 컨텍스트 2</em> 종료</li>
</ol>

<ul>
  <li>member 와 findMember 는 다른 영속성 컨텍스트에서 관리되어 서로 다른 인스턴스
    <ul>
      <li><code class="language-plaintext highlighter-rouge">assertTrue(member == findMember)</code> 실패함</li>
    </ul>
  </li>
  <li>영속성 컨텍스트 다른 경우 엔티티 비교 결과는 아래와 같음
    <ul>
      <li><strong>동일성 identical:</strong> <code class="language-plaintext highlighter-rouge">==</code> 비교 실패</li>
      <li><strong>동등성 equinalent:</strong> <code class="language-plaintext highlighter-rouge">equals()</code> 비교 만족. 대신 <code class="language-plaintext highlighter-rouge">equals()</code> 구현해야 함
        <ul>
          <li>엔티티 비교를 위해 <code class="language-plaintext highlighter-rouge">equals()</code> 구현시엔 비즈니스 키를 활용한 동등성 비교를 권장</li>
        </ul>
      </li>
      <li><strong>DB 동등성:</strong> @Id 인 DB 식별자 값 같음</li>
    </ul>
  </li>
</ul>

<p><br />
<br />
<br /></p>

<h1 id="153-프록시-심화-주제">15.3 프록시 심화 주제</h1>

<p><br />
<br /></p>

<h2 id="1531-영속성-컨텍스트와-프록시">15.3.1 영속성 컨텍스트와 프록시</h2>
<ul>
  <li>영속성 컨텍스트는 자신이 관리하는 영속 엔티티의 동일성 보장</li>
  <li>프록시로 조회한 엔티티의 경우에도 동일성을 보장함
    <ul>
      <li><strong>프록시 먼저 조회 후 원본 엔티티 조회한 경우</strong>
        <ul>
          <li>이미 프록시로 조회한 엔티티에 대해 같은 엔티티 조회 요청 오면 <strong>원본이 아닌 처음 조회된 프록시를 반환</strong></li>
          <li>∴ 둘다 동일한 프록시 반환되어 동일성 보장</li>
        </ul>
      </li>
      <li><strong>원본 엔티티 먼저 조회 후 프록시 조회한 경우</strong>
        <ul>
          <li>원본 엔티티를 이미 DB에서 조회해서 영속성 컨텍스트에서 관리중이므로 <strong>프록시로 요청해도 원본 엔티티를 반환</strong></li>
          <li>∴ 둘다 동일한 원본 엔티티 반환되어 동일성 보장</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p><br />
<br /></p>

<h2 id="1532-프록시-타입-비교">15.3.2 프록시 타입 비교</h2>

<p><img src="/assets/img/jpa_study/ch.15/pic-15-5.png" style="max-width:20%;height:auto;" /></p>

<ul>
  <li>프록시는 원본 엔티티 상속받아 만들어지므로 타입 비교시 <code class="language-plaintext highlighter-rouge">==</code> 대신 <code class="language-plaintext highlighter-rouge">instanceof</code> 사용해야 함</li>
  <li>프록시와 원본 엔티티를 <code class="language-plaintext highlighter-rouge">==</code> 로 비교하게 되면 부모 클래스와 자식 클래스를 비교한 것이 됨 =&gt; 결과는 false</li>
  <li>∴ <code class="language-plaintext highlighter-rouge">instanceof</code> 를 통해 비교해야 함</li>
</ul>

<p><br />
<br /></p>

<h2 id="1533-프록시-동등성-비교">15.3.3 프록시 동등성 비교</h2>
<ul>
  <li>엔티티 동등성 비교 시 비즈니스 키 이용해 <code class="language-plaintext highlighter-rouge">equals()</code> 메소드 오버라이딩 하여 비교하면 됨</li>
  <li>IDE나 외부 라이브러리 사용해서 구현한 <code class="language-plaintext highlighter-rouge">equals()</code> 메소드를 엔티티 비교에 사용해도 원본 엔티티면 문제 없음
    <ul>
      <li>프록시인 경우엔 문제 발생할 수 있음</li>
    </ul>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Member</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="o">...</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">name</span><span class="o">;</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span> <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span> <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="nc">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">obj</span><span class="o">)</span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">()</span> <span class="o">!=</span> <span class="n">obj</span><span class="o">.</span><span class="na">getClass</span><span class="o">())</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>    <span class="c1">// 문제점 1</span>

        <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Member</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">name</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="o">!</span><span class="n">name</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">member</span><span class="o">.</span><span class="na">name</span><span class="o">)</span> <span class="o">:</span> <span class="n">member</span><span class="o">.</span><span class="na">name</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>    <span class="c1">// 문제점 2</span>

        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">name</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">name</span><span class="o">.</span><span class="na">hashCode</span><span class="o">()</span> <span class="o">:</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="o">...</span>

<span class="nd">@TEst</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">proxyEquivalnceTest</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Member</span> <span class="n">saveMember</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Member</span><span class="o">(</span><span class="s">"member1"</span><span class="o">,</span> <span class="s">"memberA"</span><span class="o">);</span>
    <span class="n">em</span><span class="o">.</span><span class="na">persiste</span><span class="o">(</span><span class="n">saveMember</span><span class="o">);</span>
    <span class="n">em</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
    <span class="n">em</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>

    <span class="nc">Member</span> <span class="n">newMEmber</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Member</span><span class="o">(</span><span class="s">"member1"</span><span class="o">,</span> <span class="s">"memberA"</span><span class="o">);</span>
    <span class="nc">Member</span> <span class="n">refMember</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">getReference</span><span class="o">(</span><span class="nc">Member</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"memberA"</span><span class="o">);</span>

    <span class="nc">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">newMember</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">refMember</span><span class="o">));</span> <span class="c1">// 실패</span>
<span class="o">}</span>
</code></pre></div></div>

<p><img src="/assets/img/jpa_study/ch.15/pic-15-6.png" /></p>

<ul>
  <li>위 예제에서 <code class="language-plaintext highlighter-rouge">Assert.assertTrue(newMember.equals(refMember));</code> 가 실패하는 이유는 다음과 같음</li>
</ul>

<p><br /></p>

<h3 id="문제점-1-타입-비교">문제점 1: 타입 비교</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">()</span> <span class="o">!=</span> <span class="n">obj</span><span class="o">.</span><span class="na">getClass</span><span class="o">())</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</code></pre></div></div>

<ul>
  <li>프록시는 원본을 상속받은 자식 타입이므로 프록시 타입 비교시 <code class="language-plaintext highlighter-rouge">==</code> 가 아닌 <code class="language-plaintext highlighter-rouge">instanceof</code> 를 사용해야 함</li>
</ul>

<p><br /></p>

<h3 id="문제점-2-프록시-멤버-변수-접근">문제점 2: 프록시 멤버 변수 접근</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Member</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>

<span class="k">if</span> <span class="o">(</span><span class="n">name</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="o">!</span><span class="n">name</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">member</span><span class="o">.</span><span class="na">name</span><span class="o">)</span> <span class="o">:</span> <span class="n">member</span><span class="o">.</span><span class="na">name</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</code></pre></div></div>

<p><img src="/assets/img/jpa_study/ch.15/pic-15-7.png" /></p>

<p><img src="/assets/img/jpa_study/ch.15/pic-15-8.png" /></p>

<ul>
  <li>프록시는 실제 데이터를 가지고 있지 않음</li>
  <li>따라서 프록시의 멤버 변수에 직접 접근하면 아무 값도 조회할 수 없음</li>
  <li>접근자를 사용해 멤버 변수에 접근해야 원본 엔티티 조회해와서 실제 값에 접근할 수 있음</li>
</ul>

<p><br /></p>

<h3 id="문제-해결한-equals-메소드-예제">문제 해결한 equals() 메소드 예제</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="nc">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">obj</span><span class="o">)</span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(!(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="nc">Member</span><span class="o">))</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// 프록시의 타입 비교는 == 대신 instanceof 사용</span>

    <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Member</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">name</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="o">!</span><span class="n">name</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">member</span><span class="o">.</span><span class="na">getName</span><span class="o">())</span> <span class="o">:</span> <span class="n">member</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// 프록시의 멤버 변수에 직접 접근하지 말고 getter 메소드 사용</span>

    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p><br />
<br /></p>

<h2 id="1534-상속관계와-프록시">15.3.4 상속관계와 프록시</h2>
<ul>
  <li>프록시를 부모 타입으로 조회할 경우 부모 타입을 기반으로 프록시가 생성되어 문제 발생
    <ul>
      <li><code class="language-plaintext highlighter-rouge">instanceof</code> 연산 사용 불가</li>
      <li>하위 타입으로 다운 캐스팅 불가</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/img/jpa_study/ch.15/pic-15-9.png" /></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">proxyQueryByParentType</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// test 데이터 준비</span>
    <span class="nc">Book</span> <span class="n">saveBook</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Book</span><span class="o">();</span>
    <span class="n">saveBook</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"jpabook"</span><span class="o">);</span>
    <span class="n">saveBook</span><span class="o">.</span><span class="na">setAuthor</span><span class="o">(</span><span class="s">"kim"</span><span class="o">);</span>
    <span class="n">em</span><span class="o">.</span><span class="na">persist</span><span class="o">(</span><span class="n">saveBook</span><span class="o">);</span>

    <span class="n">em</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
    <span class="n">em</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>

    <span class="c1">// test 시작</span>
    <span class="nc">Item</span> <span class="n">proxyItem</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">getReference</span><span class="o">(</span><span class="nc">Item</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">saveBook</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"proxyItem = "</span> <span class="o">+</span> <span class="n">proxyItem</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>  <span class="c1">// proxyItem = class jpabook.proxy.advanced.item.Item_$$_jvstXXX</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">proxyItem</span> <span class="k">instanceof</span> <span class="n">book</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"proxyItem instance of book"</span><span class="o">);</span>
        <span class="nc">Book</span> <span class="n">book</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Book</span><span class="o">)</span> <span class="n">proxyItem</span><span class="o">;</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"author = "</span> <span class="o">+</span> <span class="n">book</span><span class="o">.</span><span class="na">getAuthor</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="c1">// assert</span>
    <span class="nc">Assert</span><span class="o">.</span><span class="na">asesertFalse</span><span class="o">(</span><span class="n">proxyItem</span><span class="o">.</span><span class="na">getClass</span><span class="o">()</span> <span class="o">==</span> <span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">Assert</span><span class="o">.</span><span class="na">assertFalse</span><span class="o">(</span><span class="n">proxyItem</span> <span class="k">instanceof</span> <span class="nc">Book</span><span class="o">);</span>  <span class="c1">// false</span>
    <span class="nc">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">proxyItem</span> <span class="k">instanceof</span> <span class="nc">Item</span><span class="o">);</span>   <span class="c1">// true</span>
<span class="o">}</span>
</code></pre></div></div>

<p><img src="/assets/img/jpa_study/ch.15/pic-15-10.png" /></p>

<ul>
  <li>위 예제의 경우 <code class="language-plaintext highlighter-rouge">em.getRefernce(Item.class, saveBook.getId())</code> 로 조회한 결과과 <code class="language-plaintext highlighter-rouge">Item</code> 을 상속받은 프록시 클래스임</li>
  <li>프록시의 원본은 <code class="language-plaintext highlighter-rouge">Book</code> 엔티티이지만 프록시 자체는 <code class="language-plaintext highlighter-rouge">Item</code> 을 상속받아 <code class="language-plaintext highlighter-rouge">Book</code> 클래스와 관련이 없기 때문에 <code class="language-plaintext highlighter-rouge">proxyItem instanceof Book</code> 의 결과가 false 가 됨</li>
  <li>따라서 다운 캐스팅을 해줘도 <code class="language-plaintext highlighter-rouge">classCastException</code> 예외가 발생함</li>
</ul>

<p><br /></p>

<h3 id="jpql로-대상-직접-조회">JPQL로 대상 직접 조회</h3>
<ul>
  <li>가장 간단한 해결책은 처음부터 자식 타입을 직접 조회해서 필요한 연산을 수행하는 것
    <ul>
      <li>대신 이 방법 사용하면 다형성 활용 못함</li>
    </ul>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Book</span> <span class="n">jpqlBook</span> <span class="o">=</span> <span class="n">em</span>
    <span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"SELECT b FROM Book b WHERE b.id=:bookId"</span><span class="o">,</span> <span class="nc">Book</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"bookId"</span><span class="o">,</span> <span class="n">item</span><span class="o">.</span><span class="na">getId</span><span class="o">())</span>
    <span class="o">.</span><span class="na">getSingleResult</span><span class="o">();</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="프록시-벗기기">프록시 벗기기</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">proxyQueryByParentType</span><span class="o">()</span> <span class="o">{</span>

    <span class="o">...</span>

    <span class="nc">Item</span> <span class="n">item</span> <span class="o">=</span> <span class="n">orderItem</span><span class="o">.</span><span class="na">getItem</span><span class="o">();</span>
    <span class="nc">Item</span> <span class="n">unProxyItem</span> <span class="o">=</span> <span class="n">unProxy</span><span class="o">(</span><span class="n">item</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">unProxyItem</span> <span class="k">instanceof</span> <span class="nc">Book</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"proxyItem insatnceof Book"</span><span class="o">);</span>
        <span class="nc">Book</span> <span class="n">book</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Book</span><span class="o">)</span> <span class="n">unProxyItem</span><span class="o">;</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"author = "</span> <span class="o">+</span> <span class="n">book</span><span class="o">.</span><span class="na">getAuthor</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nc">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">item</span> <span class="o">!=</span> <span class="n">unProxyItem</span><span class="o">);</span> <span class="c1">// true</span>
<span class="o">}</span>

<span class="c1">// 프록시에서 원본 엔티티 찾는 기능 사용 예제</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">unProxy</span><span class="o">(</span><span class="nc">Object</span> <span class="n">entity</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">entity</span> <span class="k">instanceof</span> <span class="nc">HibernateProxy</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">entity</span> <span class="o">=</span> <span class="o">((</span><span class="nc">HibernateProxy</span><span class="o">)</span> <span class="n">entity</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getHibernateLazyInitializer</span><span class="o">()</span>
            <span class="o">.</span><span class="na">getImplementation</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span> <span class="n">entity</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>위 예제와 같이 하이버네이트가 제공하는 기능 사용하면 프록시에서 원본 엔티티 가져와 프록시를 벗기고 사용할 수 있음
    <ul>
      <li><code class="language-plaintext highlighter-rouge">((HibernateProxy) entity).getHibernateLazyInitializer().getImplementation();</code></li>
    </ul>
  </li>
  <li>대신 이렇게 할 경우 프록시에서 원본 엔티티 꺼내서 사용하기 때문에 프록시와 원본 엔티티 동일성 비교가 실패함
    <ul>
      <li><code class="language-plaintext highlighter-rouge">item == unProxyItem  // false</code></li>
      <li>원래 영속성 컨텍스트는 한번 프록시로 노출한 엔티티는 계속 프록시로 노출해서 영속 엔티티의 동일성을 보장하지만 프록시 벗기면 그게 안됨</li>
    </ul>
  </li>
  <li>원본 엔티티 값을 직접 변경해도 변경 감지 기능은 동작함</li>
</ul>

<p><br /></p>

<h3 id="기능을-위한-별도의-인터페이스-제공">기능을 위한 별도의 인터페이스 제공</h3>

<p><img src="/assets/img/jpa_study/ch.15/pic-15-11.png" /></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TitleView</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="nf">getTitle</span><span class="o">();</span>
<span class="o">}</span>

<span class="o">...</span>

<span class="nd">@Entity</span>
<span class="nd">@Inheritance</span><span class="o">(</span><span class="n">startegry</span> <span class="o">=</span> <span class="nc">InheritanceType</span><span class="o">.</span><span class="na">SINGLE_TABLE</span><span class="o">)</span>
<span class="nd">@DiscriminatorColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"dtype"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Item</span> <span class="kd">implements</span> <span class="nc">TitleView</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"item_id"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">price</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">stockQuantity</span><span class="o">;</span>

    <span class="c1">// Getter, Setter</span>
<span class="o">}</span>

<span class="o">...</span>

<span class="nd">@Entity</span>
<span class="nd">@DiscriminatorValue</span><span class="o">(</span><span class="s">"M"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Movie</span> <span class="kd">extends</span> <span class="nc">Item</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">director</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">actor</span><span class="o">;</span>

    <span class="c1">// Getter, Setter</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getTitle</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"[title: "</span> <span class="o">+</span> <span class="n">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"director: "</span> <span class="o">+</span> <span class="n">director</span> <span class="o">+</span> <span class="s">"actor: "</span> <span class="o">+</span> <span class="n">actor</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="o">...</span>

<span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderItem</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@GenearatedValue</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">fetch</span> <span class="o">=</span> <span class="nc">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"item_id"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Item</span> <span class="n">item</span><span class="o">;</span>

    <span class="o">...</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">printItem</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">pritnln</span><span class="o">(</span><span class="s">"TITLE="</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="na">getTitle</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>위 예제처럼 인터페이스를 제공하고 각 클래스에서 기능을 구현하여 사용하는 것이 다형성을 활요하는 좋은 방법</li>
  <li>또한 클라이언트 입장에서 대상 객체가 프록시인지 아닌지 고려하지 않아도 됨</li>
  <li>이 방법 사용시엔 프록시의 특징 때문에 프록시의 대상이 되는 타입에 인터페이스 적용해야 함
    <ul>
      <li>위 예시의 경우 <code class="language-plaintext highlighter-rouge">Item</code> 이 인터페이스 적용 대상</li>
    </ul>
  </li>
</ul>

<p><br /></p>

<h3 id="비지터-패턴-사용">비지터 패턴 사용</h3>

<p><img src="/assets/img/jpa_study/ch.15/pic-15-12.png" /></p>

<ul>
  <li><a href="https://ko.wikipedia.org/wiki/%EB%B9%84%EC%A7%80%ED%84%B0_%ED%8C%A8%ED%84%B4">비지터 패턴</a>은 <code class="language-plaintext highlighter-rouge">Visitor</code> 와 <code class="language-plaintext highlighter-rouge">Visitor</code> 를 받아들이는 대상 클래스로 구성됨</li>
  <li>예제의 경우 <code class="language-plaintext highlighter-rouge">Item</code> 이 <code class="language-plaintext highlighter-rouge">accept(visitor)</code> 메소드로 <code class="language-plaintext highlighter-rouge">Visitor</code> 받아들임
    <ul>
      <li><code class="language-plaintext highlighter-rouge">Item</code> 은 <code class="language-plaintext highlighter-rouge">Visitor</code> 받아들이기만 하고 실제 로직은 <code class="language-plaintext highlighter-rouge">Visitor</code> 가 처리</li>
    </ul>
  </li>
</ul>

<h4 id="visitor-정의과-구현">Visitor 정의과 구현</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Visitor 인터페이스</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Visitor</span> <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">visit</span><span class="o">(</span><span class="nc">Book</span> <span class="n">book</span><span class="o">);</span>
    <span class="kt">void</span> <span class="nf">visit</span><span class="o">(</span><span class="nc">Album</span> <span class="n">album</span><span class="o">);</span>
    <span class="kt">void</span> <span class="nf">visit</span><span class="o">(</span><span class="nc">Movie</span> <span class="n">movie</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">// Visitor 구현</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PrintVisitor</span> <span class="n">implemnts</span> <span class="nc">Visitor</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">visit</span><span class="o">(</span><span class="nc">Book</span> <span class="n">book</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 넘어오는 book 은 proxy 가 아닌 원본 엔티티</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"book.class = "</span> <span class="o">+</span> <span class="n">book</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"[PrintVisitor] [title: "</span> <span class="o">+</span> <span class="n">book</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"author: "</span> <span class="o">+</span> <span class="n">book</span><span class="o">.</span><span class="na">getAuthor</span><span class="o">()</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">visit</span><span class="o">(</span><span class="nc">Album</span> <span class="n">album</span><span class="o">)</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">visit</span><span class="o">(</span><span class="nc">Movie</span> <span class="n">movie</span><span class="o">)</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>
<span class="o">}</span>

<span class="o">...</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TitleVisitor</span> <span class="n">implemnts</span> <span class="nc">Visitor</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">title</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getTitle</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">title</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">visit</span><span class="o">(</span><span class="nc">Book</span> <span class="n">book</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s">"[title: "</span> <span class="o">+</span> <span class="n">book</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"author: "</span> <span class="o">+</span> <span class="n">book</span><span class="o">.</span><span class="na">getAuthor</span><span class="o">()</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">visit</span><span class="o">(</span><span class="nc">Album</span> <span class="n">album</span><span class="o">)</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">visit</span><span class="o">(</span><span class="nc">Movie</span> <span class="n">movie</span><span class="o">)</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Visitor</code> 클래스에 모든 대상 클래스 받아들이도록 <code class="language-plaintext highlighter-rouge">visit()</code> 메소드 작성</li>
  <li><code class="language-plaintext highlighter-rouge">Visitor</code> 의 구현 클래스로 대상 클래스 내용 출력하는 <code class="language-plaintext highlighter-rouge">PrintVisitor</code>, 대상 클래스 제목 반환하는 <code class="language-plaintext highlighter-rouge">TitleVisitor</code> 작성</li>
</ul>

<h4 id="대상-클래스-작성">대상 클래스 작성</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Entity</span>
<span class="nd">@Inheritance</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="nc">InheritanceType</span><span class="o">.</span><span class="na">SINGLE_TABLE</span><span class="o">)</span>
<span class="nd">@DiscriminatorColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"dtype"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Item</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"item_id"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="o">...</span>

    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">accept</span><span class="o">(</span><span class="nc">Visitor</span> <span class="n">visitor</span><span class="o">);</span>
<span class="o">}</span>

<span class="o">...</span>

<span class="nd">@Entity</span>
<span class="nd">@DiscriminatorValue</span><span class="o">(</span><span class="s">"B"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Book</span> <span class="kd">extends</span> <span class="nc">Item</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">author</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">isbn</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">accept</span><span class="o">(</span><span class="nc">Visitor</span> <span class="n">visitor</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">visitor</span><span class="o">.</span><span class="na">visit</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// Getter, Setter</span>

    <span class="o">...</span>

<span class="o">}</span>

<span class="o">...</span>

<span class="nd">@Entity</span>
<span class="nd">@DiscriminatorValue</span><span class="o">(</span><span class="s">"M"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Movie</span> <span class="kd">extends</span> <span class="nc">Item</span> <span class="o">{</span>

    <span class="o">...</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">accept</span><span class="o">(</span><span class="nc">Visitor</span> <span class="n">visitor</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">visitor</span><span class="o">.</span><span class="na">visit</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="o">...</span>

<span class="nd">@Entity</span>
<span class="nd">@DiscriminatorValue</span><span class="o">(</span><span class="s">"A"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Album</span> <span class="kd">extends</span> <span class="nc">Item</span> <span class="o">{</span>

    <span class="o">...</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">accept</span><span class="o">(</span><span class="nc">Visitor</span> <span class="n">visitor</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">visitor</span><span class="o">.</span><span class="na">visit</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>각 자식 클래스에 부모에서 정의한 <code class="language-plaintext highlighter-rouge">accept(visitor)</code> 메소드 구현
    <ul>
      <li>파라미터로 넘어온 <code class="language-plaintext highlighter-rouge">Visitor</code> 의 <code class="language-plaintext highlighter-rouge">visit(this)</code> 메소드 호출하며 자신을 파라미터로 넘기는게 전부임</li>
      <li>실제 로직 처리는 <code class="language-plaintext highlighter-rouge">visitor</code> 에 위임</li>
    </ul>
  </li>
</ul>

<h4 id="비지터-패턴-실행">비지터 패턴 실행</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">visitorPattern</span><span class="o">()</span> <span class="o">{</span>

    <span class="o">...</span>

    <span class="nc">OrderItem</span> <span class="n">orderItem</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="nc">OrderItem</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">orderItemId</span><span class="o">);</span>
    <span class="nc">Item</span> <span class="n">item</span> <span class="o">=</span> <span class="n">orderItem</span><span class="o">.</span><span class="na">getItem</span><span class="o">();</span>

    <span class="c1">// PrintVisitor</span>
    <span class="n">item</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">new</span> <span class="nc">PrintVisitor</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div></div>

<p><img src="/assets/img/jpa_study/ch.15/pic-15-13.png" /></p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">item.accept()</code> aㅔ소드 호출하며 파라미터로 <code class="language-plaintext highlighter-rouge">PrintVisitor</code> 전달</li>
  <li><code class="language-plaintext highlighter-rouge">item</code> 은 프록시이므로 <code class="language-plaintext highlighter-rouge">ProxyItem</code> 이 먼저 <code class="language-plaintext highlighter-rouge">accept()</code> 메소드 받고 원본 엔티티 <code class="language-plaintext highlighter-rouge">Book</code> 의 ```accept()`` 실행</li>
  <li>원본 엔티티는 <code class="language-plaintext highlighter-rouge">visitor.visit(this)</code> 실행해서 자신을 <code class="language-plaintext highlighter-rouge">visitor</code> 에 파라미터로 전달</li>
  <li><code class="language-plaintext highlighter-rouge">visitor</code> 가 <code class="language-plaintext highlighter-rouge">PrintVisitor</code> 타입이므로 <code class="language-plaintext highlighter-rouge">PrintVisitor::visit(Book book)</code> 메소드가 실행
    <ul>
      <li><code class="language-plaintext highlighter-rouge">PrintVisitor::visit(Book book)</code> 으로 넘어오는 엔티티는 프록시가 아닌 원본 엔티티</li>
    </ul>
  </li>
</ol>

<h4 id="비지터-패턴과-확장성">비지터 패턴과 확장성</h4>
<ul>
  <li>비지터 패턴은 새로운 기능 필요할 때 <code class="language-plaintext highlighter-rouge">Visitor</code> 만 추가하면 됨</li>
  <li>따라서 기존 코드 구조 변경 없이 기능 추가할 수 있음</li>
</ul>

<h4 id="비지터-패턴-정리">비지터 패턴 정리</h4>
<ul>
  <li>장점
    <ul>
      <li><strong>프록시 걱정 없이 안전하게 원본 엔티티 접근 가능</strong></li>
      <li><strong>instanceof, 타입캐스팅 없이 코드 구현 가능</strong></li>
      <li><strong>알고리즘과 객체 구조 분리하여 구조 수정 없이 새로운 동작 추가 가능</strong></li>
    </ul>
  </li>
  <li>단점
    <ul>
      <li><strong>복잡도가 높으며 <a href="https://en.wikipedia.org/wiki/Double_dispatch">더블 디스패치</a> 사용하여 난해할 수 있음</strong></li>
      <li><strong>객체 구조 변경시 모든 Visitor 수정해야 함</strong></li>
    </ul>
  </li>
</ul>

<p><br />
<br />
<br /></p>

<h1 id="154-성능-최적화">15.4 성능 최적화</h1>

<p><br /></p>

<h2 id="1541-n1-문제">15.4.1 N+1 문제</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Member</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">"member"</span><span class="o">,</span> <span class="n">fetch</span> <span class="o">=</span> <span class="nc">FetchType</span><span class="o">.</span><span class="na">EAGER</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Order</span><span class="o">&gt;</span> <span class="n">orders</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Order</span><span class="o">&gt;();</span>

    <span class="o">...</span>
<span class="o">}</span>

<span class="o">...</span>

<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"orders"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@ManyToOne</span>
    <span class="kd">private</span> <span class="nc">Member</span> <span class="n">member</span><span class="o">;</span>

    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>Member 와 Order 는 1:N, N:1 양방향 연관관계</li>
  <li>Member 가 참조하는 <code class="language-plaintext highlighter-rouge">Member.orders</code> 를 즉시 로딩으로 설정</li>
</ul>

<p><br /></p>

<h3 id="즉시-로딩과-n1">즉시 로딩과 N+1</h3>
<ul>
  <li>특정 Member 를 <code class="language-plaintext highlighter-rouge">em.find()</code> 로 조회 시 즉시 로딩 설정한 order 도 함께 조회됨
    <ul>
      <li>이 때는 join 사용해서 Member, Order 를 함께 조회</li>
    </ul>
  </li>
  <li>JPQL로 조회할 경우엔 즉시 로딩, 지연 로딩 설정 여부 상관안함
    <ul>
      <li>Member와 Order를 join으로 함께 조회하지 않고 Member 만 조회함</li>
      <li>이후 JPA가 Order 도 즉시 로딩 하기 위해 추가적으로 조회 쿼리 날림</li>
      <li>이 때 처음 실행한 SQL 의 결과 수만큼 추가로 SQL 실행됨 =&gt; N+1 문제</li>
    </ul>
  </li>
</ul>

<p><br /></p>

<h3 id="지연-로딩과-n1">지연 로딩과 N+1</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 지연 로딩 설정</span>
<span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Member</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">"memgber"</span><span class="o">,</span> <span class="n">fetch</span> <span class="o">=</span> <span class="nc">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Order</span><span class="o">&gt;</span> <span class="n">orders</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Order</span><span class="o">&gt;();</span>

    <span class="o">...</span>
<span class="o">}</span>

<span class="o">...</span>

<span class="c1">// 지연 로딩 설정해도 N+1 문제 발생하는 예시</span>
<span class="k">for</span> <span class="o">(</span><span class="nc">Member</span> <span class="nl">member:</span> <span class="n">members</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 지연 로딩 초기화</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"member = "</span> <span class="o">+</span> <span class="n">member</span><span class="o">.</span><span class="na">getOrders</span><span class="o">().</span><span class="na">size</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>지연 로딩시에도 문제 발생할 수 있음</li>
  <li>위 예제처럼 모든 Member 에 대해 연관된 Order 컬렉션 사용시 Order 컬렉션 초기화하는 수만큼 Order 조회 쿼리가 실행될 수 있음
    <ul>
      <li>Member 수만큼 Order 조회 쿼리 수행되므로 N+1 문제</li>
    </ul>
  </li>
</ul>

<p><br /></p>

<h3 id="페치-조인-사용">페치 조인 사용</h3>
<ul>
  <li>N+1 문제의 가장 일반적 해결법은 fetch join 사용</li>
  <li>fetch 조인은 SQL 조인 사용해서 연관된 엔티티 한번에 조회하므로 N+1 문제 발생 안함</li>
</ul>

<p><br /></p>

<h3 id="하이버네이트-batchsize">하이버네이트 @BatchSize</h3>
<ul>
  <li>하이버네이트의 <code class="language-plaintext highlighter-rouge">org.hibernate.annotations.BatchSize</code> 어노테이션 사용하면 연관된 엔티티 조회 시 지정한 size 만큼 SQL 의 IN 절 사용해서 조회
    <ul>
      <li>Member  10명일 때 size=5 지정하면 2번의 쿼리만 추가 실행</li>
    </ul>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Member</span> <span class="o">{</span>

    <span class="o">...</span>

    <span class="nd">@BatchSize</span><span class="o">(</span><span class="n">size</span> <span class="o">=</span> <span class="mi">5</span><span class="o">)</span>
    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">"member"</span><span class="o">,</span> <span class="n">fetch</span> <span class="o">=</span> <span class="nc">FetchType</span><span class="o">.</span><span class="na">EAGER</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Order</span><span class="o">&gt;</span> <span class="n">orders</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Order</span><span class="o">&gt;();</span>

    <span class="o">...</span>

<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>즉시 로딩으로 설정하면 조회 시점에 N 개 데이터 모두 조회해야 해서 쿼리가 N/size 번 수행</li>
  <li>지연 로딩으로 설정하면 지연 로딩된 엔티티 최초 사용 시점에 쿼리 한번 수행해서 size 개 데이터 미리 로딩, 이후 size+1 번째 데이터 사용시 추가로 조회</li>
  <li><code class="language-plaintext highlighter-rouge">SELECT * FROM orders WHERE member_id IN (?, ?, ?, ?, ?)    // @BatchSize(size=5) 설정시 수행되는 쿼리</code></li>
</ul>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">hibernate.default_batch_fetch_size</code> 속성 사용하여 <code class="language-plaintext highlighter-rouge">@BatchSize</code> 글로벌 적용 가능함<br />
<code class="language-plaintext highlighter-rouge">&lt;property name="hibernate.default_batch_fetch_size" value="5" /&gt;</code></p>
</blockquote>

<p><br /></p>

<h3 id="하이버네이트-fetchfetchmodesubselect">하이버네이트 @Fetch(FetchMode.SUBSELECT)</h3>
<ul>
  <li>하이버네이트의 <code class="language-plaintext highlighter-rouge">org.hibernate.annotations.Fetch</code> 어노테이션에 FetchMode 를 SUBSELECT 로 사용하면 연관 데이터 조회시 서브 쿼리 사용해서 N+1 문제 해결</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Member</span> <span class="o">{</span>

    <span class="o">...</span>

    <span class="nd">@Fetch</span><span class="o">(</span><span class="nc">FetchMode</span><span class="o">.</span><span class="na">SUBSELECT</span><span class="o">)</span>
    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">"member"</span><span class="o">,</span> <span class="n">fetch</span> <span class="o">=</span> <span class="nc">FetchType</span><span class="o">.</span><span class="na">EAGER</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Order</span><span class="o">&gt;</span> <span class="n">orders</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Order</span><span class="o">&gt;();</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// @Fetch(FetchMode.SUBSELECT) 사용하는 JPQL 예제</span>
<span class="no">SELECT</span> <span class="n">m</span> 
<span class="no">FROM</span> <span class="nc">Member</span> <span class="n">m</span> 
<span class="no">WHERE</span> <span class="n">m</span><span class="o">.</span><span class="na">id</span> <span class="o">&gt;</span> <span class="mi">10</span>
</code></pre></div></div>

<ul>
  <li>위와 같은 JPQL 로 Member 조회하면 지연 로딩된 엔티티 사용하는 시점에 다음과 같은 SQL 실행됨</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">#</span> <span class="k">SQL</span>
<span class="k">SELECT</span> <span class="n">o</span> <span class="k">FROM</span> <span class="n">orders</span> <span class="n">o</span>
<span class="k">WHERE</span> <span class="n">o</span><span class="p">.</span><span class="n">member_id</span> <span class="k">IN</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">m</span><span class="p">.</span><span class="n">id</span>
    <span class="k">FROM</span> <span class="n">member</span> <span class="n">m</span>
    <span class="k">WHERE</span> <span class="n">m</span><span class="p">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">10</span>
<span class="p">)</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="n1-정리">N+1 정리</h3>
<ul>
  <li>즉시 로딩 말고 지연 로딩만 사용하는 것 권장
    <ul>
      <li>즉시 로딩은 N+1 문제 뿐만 아니라 필요없는 엔티티도 로딩해야 하는 상황 자주 발생</li>
      <li>이러한 이유로 즉시 로딩은 성능 최적화가 어려움</li>
      <li>따라서 모두 지연 로딩 설정 후 성능 최적화 필수인 곳에 JPQL 페치 조인 사용하는 게 좋음</li>
    </ul>
  </li>
  <li>JPA 글로벌 페치 전략 기본값
    <ul>
      <li><code class="language-plaintext highlighter-rouge">@OneToOne</code>, <code class="language-plaintext highlighter-rouge">@ManyToOne</code>: 즉시 로딩</li>
      <li><code class="language-plaintext highlighter-rouge">@OneToMany</code>, <code class="language-plaintext highlighter-rouge">@ManyToMany</code>: 지연 로딩</li>
      <li>따라서 기본값이 즉시 로딩인 <code class="language-plaintext highlighter-rouge">@OneToOne</code>, <code class="language-plaintext highlighter-rouge">@ManyToOne</code> 은 지연 로딩 설정 해줘서 사용하는게 좋다</li>
    </ul>
  </li>
</ul>

<p><br />
<br /></p>

<h2 id="1542-읽기-전용-쿼리의-성능-최적화">15.4.2 읽기 전용 쿼리의 성능 최적화</h2>
<ul>
  <li>영속성 컨텍스트는 변경 감지를 위해 스냅샷 인스턴스를 보관하기 때문에 더 많은 메모리를 사용함</li>
  <li>만약 수정이나 여러번의 조회가 필요 없이 딱 한 번만 조회해서 사용하면 되는 경우 영속성 컨텍스트에 의해 관리되지 않는 읽기 전용으로 조회하면 메모리 사용량을 최적화 할 수 있음</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 최적화 전 JPQL</span>
<span class="no">SELECT</span> <span class="n">o</span> <span class="no">FROM</span> <span class="nc">Order</span> <span class="n">o</span>
</code></pre></div></div>

<h4 id="스칼라-타입으로-조회">스칼라 타입으로 조회</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 스칼라 타입으로 조회 JPQL</span>
<span class="no">SELECT</span> <span class="n">o</span><span class="o">.</span><span class="na">id</span><span class="o">,</span> <span class="n">o</span><span class="o">.</span><span class="na">name</span><span class="o">,</span> <span class="n">o</span><span class="o">.</span><span class="na">price</span> <span class="no">FROM</span> <span class="nc">Order</span> <span class="n">p</span>
</code></pre></div></div>

<ul>
  <li>엔티티가 아닌 스칼라 타입으로 모든 필드를 조회하는 방법</li>
  <li>스칼라 타입은 영속성 컨텍스트가 결과 관리 안함</li>
</ul>

<h4 id="읽기-전용-쿼리-힌트-사용">읽기 전용 쿼리 힌트 사용</h4>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 읽기 전용 쿼리 힌트 사용 예제</span>
<span class="nc">TypedQuery</span><span class="o">&lt;</span><span class="nc">Order</span><span class="o">&gt;</span> <span class="n">query</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"SELECT o FROM Order o"</span><span class="o">,</span> <span class="nc">Order</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">setHint</span><span class="o">(</span><span class="s">"org.hibernate.readOnly"</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</code></pre></div></div>

<ul>
  <li>하이버네이트 전용 힌트 <code class="language-plaintext highlighter-rouge">org.hibernate.readOnly</code> 사용하여 읽기 전용으로 조회할 수 있음</li>
  <li>영속성 컨텍스트는 해당 엔티티에 대해 스냅샷 보관하지 않음
    <ul>
      <li>따라서 메모리 사용량 최적화 되고 대신 스냅샷 없어서 엔티티 수정해도 DB 반영 안됨</li>
    </ul>
  </li>
</ul>

<h4 id="읽기-전용-트랜잭션-사용">읽기 전용 트랜잭션 사용</h4>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 트랜잭션 읽기 전용 모드 설정</span>
<span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Order</span><span class="o">&gt;</span> <span class="nf">getOrders</span><span class="o">()</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>트랜잭션에 <code class="language-plaintext highlighter-rouge">readOnly = true</code> 옵션 주면 스프링 프레임워크가 하이버네이트 세션의 flush mode 를 MANUAL 로 설정함
    <ul>
      <li>강제로 플러시 호출 안하면 플러시 안일어남</li>
      <li>따라서 트랜잭션 커밋해도 영속성 컨텍스트 플러시 되지 않아 엔티티 등록, 수정, 삭제 동작하지 않음</li>
      <li>덕분에 플러시 시 발생하는 스냅샷 비교 등의 무거운 로직 수행되지 않아 성능 향상됨</li>
    </ul>
  </li>
</ul>

<h4 id="트랜잭션-밖에서-읽기">트랜잭션 밖에서 읽기</h4>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 트랜잭션 밖에서 읽기 설정</span>
<span class="nd">@Transactional</span><span class="o">(</span><span class="n">propagation</span> <span class="o">=</span> <span class="nc">Propagation</span><span class="o">.</span><span class="na">NOT_SUPPORTED</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Order</span><span class="o">&gt;</span> <span class="nf">getOrders</span><span class="o">()</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>트랜잭션 없이 엔티티를 조회하는 방법</li>
  <li>데이터 변경하려면 트랜잭션 필수이기 때문에 조회가 목적일 때만 사용해야 함</li>
  <li>이렇게 조회하면 트랜잭션 사용하지 않아 flush 도 일어나지 않으므로 조회 성능이 향상됨</li>
</ul>

<h4 id="정리">정리</h4>
<ul>
  <li>읽기 전용 데이터 조회시
    <ul>
      <li><strong>메모리 최적화 하려면</strong>
        <ul>
          <li>스칼라 타입으로 조회</li>
          <li>하이버네이트의 읽기 전용 쿼리 힌트 사용</li>
        </ul>
      </li>
      <li><strong>flush 호출을 막아 속도 최적화 하려면</strong>
        <ul>
          <li>읽기 전용 트랜잭션 사용 (스프링에서는 이게 더 편함)</li>
          <li>트랜잭션 밖에서 읽기</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>따라서 아래 예제와 같이 읽기 전용 트랜잭션(or 트랜잭션 밖에서 읽기) 랑 읽기 전용 쿼리 힌트(or 스칼라 타입으로 조회) 동시에 사용하는게 가장 효과적임</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span> <span class="c1">// 읽기 전용 트랜잭션: flush 막아서 성능 향상</span>
<span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">DataEntity</span><span class="o">&gt;</span> <span class="nf">findDatas</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"SELECT d FROM DataEntity d"</span><span class="o">,</span> <span class="nc">DataEntity</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="o">.</span><span class="na">setHint</span><span class="o">(</span><span class="s">"org.hibernate.readOnly"</span><span class="o">,</span> <span class="kc">true</span><span class="o">)</span>    <span class="c1">// 읽기 전용 엔티티 사용: 읽기 전용으로 조회해서 메모리 절약</span>
    <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p><br />
<br /></p>

<h2 id="1543-배치-처리">15.4.3 배치 처리</h2>
<ul>
  <li>수많은 데이터 배치 처리해야하는 상황에서 일반적 방식으로 엔티티 계속 조회시 영속성 컨텍스트에 엔티티 과도하게 쌓여 메모리 부족 에러 남</li>
  <li>∴ 이런 배치 처리는 <strong>적절한 단위로 영속성 컨텍스트 초기화</strong>해야 하며, 2차 캐시 사용중이면 <strong>2차 캐시에 엔티티 보관하지 않도록 주의</strong></li>
</ul>

<p><br /></p>

<h3 id="jpa-등록-배치">JPA 등록 배치</h3>
<ul>
  <li>영속성 컨텍스트에 엔티티가 계속 쌓이지 않도록 일정 단위마다 영속성 컨텍스트의 엔티티를 DB 에 플러시 하고 영속성 컨텍스트 초기화 해야함</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
    <span class="nc">Product</span> <span class="n">product</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Product</span><span class="o">(</span><span class="s">"item"</span> <span class="o">+</span> <span class="n">i</span><span class="o">,</span> <span class="mi">10000</span><span class="o">);</span>
    <span class="n">em</span><span class="o">.</span><span class="na">persist</span><span class="o">(</span><span class="n">product</span><span class="o">);</span>

    <span class="c1">// 100건 마다 플러시하고 영속성 컨텍스트 초기화</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">em</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
        <span class="n">em</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="jpa-수정-배치">JPA 수정 배치</h3>
<ul>
  <li>수정 배치 처리시에는 다량의 데이터를 조회해서 수정해야 하는데 이 때 수많은 데이터를 한 번에 메모리에 올려둘 수 없어 다음 두 가지 방법을 주로 사용
    <ul>
      <li><strong>페이징 처리:</strong> DB 페이징 기능을 사용</li>
      <li><strong>커서 CURSOR:</strong> DB 가 지원하는 커서 기능을 사용
        <ul>
          <li>JPA 는 JDBC CURSOR 지원하지 않으므로 하이버네이트 Session 사용해야 함</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h4 id="jpa-페이징-배치-처리">JPA 페이징 배치 처리</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">pageSize</span> <span class="o">=</span> <span class="mi">100</span><span class="o">;</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;</span> <span class="n">resultList</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"SELECT p FROM Product p"</span><span class="o">,</span> <span class="nc">Product</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setFirstResult</span><span class="o">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">pageSize</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setMaxResults</span><span class="o">(</span><span class="n">pageSize</span><span class="o">)</span>    <span class="c1">// 한 번에 100 건씩 페이징 쿼리로 조회하고 로직 수행 후 flsuh, clear</span>
        <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>

    <span class="c1">// 비즈니스 로직 실행</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">Product</span> <span class="nl">prodcut:</span> <span class="n">resultList</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">product</span><span class="o">.</span><span class="na">setPrice</span><span class="o">(</span><span class="n">product</span><span class="o">.</span><span class="na">getPrice</span><span class="o">()</span> <span class="o">+</span> <span class="mi">100</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="n">em</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
    <span class="n">em</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>페이징 조회해서 페이지 단위마다 로직 수행하고 플러시, 초기화</li>
</ul>

<h4 id="하이버네이트-scroll-사용">하이버네이트 scroll 사용</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">EntityTransaction</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">();</span>
<span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">unwrap</span><span class="o">(</span><span class="nc">Session</span><span class="o">.</span><span class="na">class</span><span class="o">);</span> <span class="c1">// hibernate 세션 구함</span>

<span class="n">tx</span><span class="o">.</span><span class="na">begin</span><span class="o">();</span>
<span class="nc">ScrollableResults</span> <span class="n">scroll</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"SELECT p FROM Product p"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">setCacheMode</span><span class="o">(</span><span class="nc">CacheMode</span><span class="o">.</span><span class="na">IGNORE</span><span class="o">)</span> <span class="c1">// 2차 캐시 기능 off</span>
    <span class="o">.</span><span class="na">scroll</span><span class="o">(</span><span class="nc">ScrollMode</span><span class="o">.</span><span class="na">FORWARD_ONLY</span><span class="o">);</span>

<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

<span class="k">while</span> <span class="o">(</span><span class="n">scroll</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
    <span class="nc">Product</span> <span class="n">p</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Product</span><span class="o">)</span> <span class="n">scroll</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="n">p</span><span class="o">.</span><span class="na">setPrice</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">getPrice</span><span class="o">()</span> <span class="o">+</span> <span class="mi">100</span><span class="o">);</span>

    <span class="n">count</span><span class="o">++;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">session</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="n">tx</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
<span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</code></pre></div></div>

<ul>
  <li>하이버네이트는 Scroll 이라는 이름으로 JDBC 커서 지원</li>
  <li>scroll은 하이버네이트 전용 기능이므로 <code class="language-plaintext highlighter-rouge">em.unwrap()</code> 으로 하이버네이트 세션 먼저 구함</li>
  <li>쿼리 조회하면서 <code class="language-plaintext highlighter-rouge">scroll()</code> 메소드로 <code class="language-plaintext highlighter-rouge">ScrollableResults</code> 객체 반환받음</li>
  <li><code class="language-plaintext highlighter-rouge">ScrollableResults</code> 객체의 <code class="language-plaintext highlighter-rouge">next()</code> 메소드 호출하면 엔티티 하나씩 조회 가능</li>
</ul>

<h4 id="하이버네이트-무상태-세션-사용">하이버네이트 무상태 세션 사용</h4>
<ul>
  <li>영속성 컨텍스트를 만들지 않고 2차 캐시도 사용하지 않는 세션</li>
  <li>일반 하이버네이트 세션과 거의 비슷하지만 영속성 컨텍스트가 없음
    <ul>
      <li>영속성 컨텍스트를 플러시하거나 초기화하지 않아도 됨</li>
      <li>대신 엔티티 수정시 무상태 세션이 제공하는 <code class="language-plaintext highlighter-rouge">update()</code> 메소드 직접 호출해야 함</li>
    </ul>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">SessionFactory</span> <span class="n">sessionFactory</span> <span class="o">=</span> <span class="n">entityManagerFactory</span><span class="o">.</span><span class="na">unwrap</span><span class="o">(</span><span class="nc">SessionFactory</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">StatelessSession</span> <span class="n">session</span> <span class="o">=</span> <span class="n">sessionFactory</span><span class="o">.</span><span class="na">openStatelessSession</span><span class="o">();</span>
<span class="nc">Transaction</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">();</span>

<span class="nc">ScrollableResults</span> <span class="n">scroll</span> <span class="o">=</span> <span class="n">sesssion</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"SELECT p FROM Product p"</span><span class="o">).</span><span class="na">scroll</span><span class="o">();</span>

<span class="k">while</span> <span class="o">(</span><span class="n">scroll</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
    <span class="nc">Product</span> <span class="n">p</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Product</span><span class="o">)</span> <span class="n">scroll</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="n">p</span><span class="o">.</span><span class="na">setPrice</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">getPrice</span><span class="o">()</span> <span class="o">+</span> <span class="mi">100</span><span class="o">);</span>
    <span class="n">session</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">p</span><span class="o">)</span>   <span class="c1">// 값 수정하기 위해 StatelessSession 의 update 메소드 호출</span>
<span class="o">}</span>

<span class="n">tx</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
<span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</code></pre></div></div>

<p><br />
<br /></p>

<h2 id="1544-sql-쿼리-힌트-사용">15.4.4 SQL 쿼리 힌트 사용</h2>
<ul>
  <li>JPA는 DB SQL 힌트(JPA 가 아닌 DB 벤더에게 제공하는 힌트) 기능 제공하지 않아 하이버네이트 직접 사용해야 함</li>
  <li>SQL 힌트는 하이버네이트 쿼리의 <code class="language-plaintext highlighter-rouge">addQueryHint()</code> 메소드 사용</li>
  <li>하이버네이트 4.3.10 까지는 오라클 방언만 힌트 적용됨
    <ul>
      <li>다른 DB 에서 사용하려면 각 방언에서 <code class="language-plaintext highlighter-rouge">org.hibernate.dialect.Dialect</code> 에 있는 다음 메소드 오버라이딩해서 기능 구현해야 함
        <ul>
          <li><code class="language-plaintext highlighter-rouge">public String getQueryHintString(String query, List&lt;String&gt; hints) { return query; }</code></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SQL 쿼리 힌트 사용 예제</span>
<span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">unwrap</span><span class="o">(</span><span class="nc">Session</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>  <span class="c1">// 하이버네이트 직접 사용</span>

<span class="nc">List</span><span class="o">&lt;</span><span class="nc">MembeR</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">ession</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"SELECT m FROM Member m"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">addQueryHint</span><span class="o">(</span><span class="s">"FULL (member)"</span><span class="o">)</span>  <span class="c1">// SQL hint 추가</span>
    <span class="o">.</span><span class="na">list</span><span class="o">();</span>
</code></pre></div></div>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">#</span> <span class="err">실행된</span> <span class="k">SQL</span>
<span class="k">SELECT</span>
    <span class="cm">/*+ FULL (member) */</span> <span class="n">m</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="n">name</span>
<span class="k">FROM</span>
    <span class="n">member</span> <span class="n">m</span>
</code></pre></div></div>

<p><br />
<br /></p>

<h2 id="1545-트랜잭션을-지원하는-쓰기-지연과-성능-최적화">15.4.5 트랜잭션을 지원하는 쓰기 지연과 성능 최적화</h2>

<p><br /></p>

<h3 id="트랜잭션을-지원하는-쓰기-지연과-jdbc-배치">트랜잭션을 지원하는 쓰기 지연과 JDBC 배치</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 최적화 전 예시</span>
<span class="n">insert</span><span class="o">(</span><span class="n">member1</span><span class="o">);</span>    <span class="c1">// INSERT INTO ...</span>
<span class="n">insert</span><span class="o">(</span><span class="n">member2</span><span class="o">);</span>    <span class="c1">// INSERT INTO ...</span>
<span class="n">insert</span><span class="o">(</span><span class="n">member3</span><span class="o">);</span>    <span class="c1">// INSERT INTO ...</span>

<span class="o">...</span>

<span class="n">commit</span><span class="o">();</span>
</code></pre></div></div>

<ul>
  <li>네트워크 호출 한 번은 단순 메소드 수만 번 호출보다 비용 큼
    <ul>
      <li>위 예시처럼 여러 번에 걸쳐 DB 와 통신하면 비용 많이 듬</li>
      <li>따라서 이걸 최적화 하려면 쿼리 모아서 한 번에 DB 에 보내면 됨</li>
    </ul>
  </li>
  <li>JDBC 의 SQL 배치 기능 사용하면 SQL 모아서 DB에 보낼 수 있음
    <ul>
      <li>다만 이 기능 사용하려면 코드 상당수 수정 필요하고 복잡하며 지저분함</li>
      <li>따라서 보통 수백, 수천 건 이상 데이터 변경하는 경우 사용</li>
    </ul>
  </li>
  <li>JPA 는 플러시 기능이 있어 SQL 배치 기능 효과적으로 사용 가능</li>
  <li>SQL 배치 최적화 전략은 구현체 마다 차이가 있으며 하이버네이트는 다음과 같이 설정
    <ul>
      <li><code class="language-plaintext highlighter-rouge">&lt;property name="hibernate.jdbc.batch_size" value="50"/&gt;</code></li>
      <li>이렇게 설정하면 데이터 등록, 수정, 삭제 시 SQL 배치 기능을 사용함</li>
      <li>위 예시의 경우 value=50 으로 설정하여 최대 50건씩 모아서 SQL 배치 실행</li>
    </ul>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SQL 배치 적용 예시</span>
<span class="n">em</span><span class="o">.</span><span class="na">persist</span><span class="o">(</span><span class="k">new</span> <span class="nc">Member</span><span class="o">());</span>   <span class="c1">// 1</span>
<span class="n">em</span><span class="o">.</span><span class="na">persist</span><span class="o">(</span><span class="k">new</span> <span class="nc">Member</span><span class="o">());</span>   <span class="c1">// 2</span>
<span class="n">em</span><span class="o">.</span><span class="na">persist</span><span class="o">(</span><span class="k">new</span> <span class="nc">Member</span><span class="o">());</span>   <span class="c1">// 3</span>
<span class="n">em</span><span class="o">.</span><span class="na">persist</span><span class="o">(</span><span class="k">new</span> <span class="nc">Member</span><span class="o">());</span>   <span class="c1">// 4</span>
<span class="n">em</span><span class="o">.</span><span class="na">persist</span><span class="o">(</span><span class="k">new</span> <span class="nc">Child</span><span class="o">());</span>   <span class="c1">// 5, 다른 연산. </span>
<span class="n">em</span><span class="o">.</span><span class="na">persist</span><span class="o">(</span><span class="k">new</span> <span class="nc">Member</span><span class="o">());</span>   <span class="c1">// 6</span>
<span class="n">em</span><span class="o">.</span><span class="na">persist</span><span class="o">(</span><span class="k">new</span> <span class="nc">Member</span><span class="o">());</span>   <span class="c1">// 7</span>
</code></pre></div></div>
<ul>
  <li>SQL 배치는 동일한 SQL 일 때만 유효함
    <ul>
      <li>중간에 다른 처리 들어가면 SQL 배치 다시 시작함</li>
    </ul>
  </li>
  <li>위 예시 같은 경우 5 번이 다른 처리이기 때문에 1, 2, 3, 4 묶어서 실행 후 5번 실행하고 나머지 6, 7 번 묶어서 실행함</li>
</ul>

<blockquote>
  <p>IDENTITY 식별자 생성 전략은 엔티티 DB 저장해야 식별자 구할 수 있어서 em.persist() 호출 즉시 INSER SQL 이 DB 에 전달됨<br />
∴ 쓰기 지연 활용한 성능 최적화 불가능함</p>
</blockquote>

<p><br /></p>

<h3 id="트랜잭션을-지원하는-쓰기-지연과-애플리케이션-확장성">트랜잭션을 지원하는 쓰기 지연과 애플리케이션 확장성</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">update</span><span class="o">(</span><span class="n">memberA</span><span class="o">);</span>    <span class="c1">// UPDATE SQL A</span>
<span class="n">logicA</span><span class="o">();</span>   <span class="c1">// UPDATE SQL ...</span>
<span class="n">logicB</span><span class="o">();</span>   <span class="c1">// INSER SQL ...</span>
<span class="n">commit</span><span class="o">();</span>
</code></pre></div></div>

<ul>
  <li>트랜잭션을 지원하는 쓰기 지연의 진짜 장점은 <strong>DB 테이블 row에 lock 걸리는 시간을 최소화 한다는 것</strong></li>
  <li>트랜잭션을 커밋해서 영속성 컨텍스트 플러시하기 전까지는 DB에 데이터 등록, 수정, 삭제 안함
    <ul>
      <li>∴ 커밋 직전까지 DB row 에 lock 안 검</li>
    </ul>
  </li>
  <li>JPA 사용하지 않고 직접 SQL 다루면 commit 할 때까지 lock 유지됨
    <ul>
      <li>위 예제의 경우 <code class="language-plaintext highlighter-rouge">update(memberA)</code> 에서부터 lock 걸려서 <code class="language-plaintext highlighter-rouge">commit()</code> 까지 유지</li>
    </ul>
  </li>
  <li>JPA 사용하면 커밋 해야 플러시 호출하고 DB에 쿼리 보내지기 때문에 DB 락 걸리는 시간이 최소화 됨
    <ul>
      <li>위 예제의 경우 <code class="language-plaintext highlighter-rouge">commit()</code> 할 때 UPDATE, INSERT 쿼리 DB 로 보내져서 lock 걸고 수행 후 커밋하고 바로 풀림</li>
    </ul>
  </li>
</ul>

</article>



<section class="tags">
  <strong>Tags:</strong> <a href="/tag/jpa">jpa</a>,&nbsp;<a href="/tag/performance-optimization">performance-optimization</a>,&nbsp;<a href="/tag/performance">performance</a>,&nbsp;<a href="/tag/optimization">optimization</a>,&nbsp;<a href="/tag/exception">exception</a>,&nbsp;<a href="/tag/compare">compare</a>,&nbsp;<a href="/tag/proxy">proxy</a>
</section>



<section class="rss">
  <p class="rss-subscribe text"><strong>Subscribe <a href="/feed.xml">via RSS</a></strong></p>
</section>

<section class="share">
  <span>Share: </span>
  
    
    
      <a href="//twitter.com/share?text=%5B%EC%9E%90%EB%B0%94+ORM+%ED%91%9C%EC%A4%80+JPA+%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D%5D+15%EC%9E%A5.+%EA%B3%A0%EA%B8%89+%EC%A3%BC%EC%A0%9C%EC%99%80+%EC%84%B1%EB%8A%A5+%EC%B5%9C%EC%A0%81%ED%99%94&url=https%3A%2F%2Fsungunjo.github.io%2Fjpa-study%2F2022%2F03%2F31%2Fch.15-advanced-topics-and-performance-optimization.html&via="
        onclick="window.open(this.href, 'twitter-share', 'width=550,height=255');return false;">
        <i class="fa fa-twitter-square fa-lg"></i>
      </a>
    
    
    
    
    
    
    
  
    
    
    
      <a href="//www.facebook.com/sharer.php?t=%5B%EC%9E%90%EB%B0%94+ORM+%ED%91%9C%EC%A4%80+JPA+%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D%5D+15%EC%9E%A5.+%EA%B3%A0%EA%B8%89+%EC%A3%BC%EC%A0%9C%EC%99%80+%EC%84%B1%EB%8A%A5+%EC%B5%9C%EC%A0%81%ED%99%94&u=https%3A%2F%2Fsungunjo.github.io%2Fjpa-study%2F2022%2F03%2F31%2Fch.15-advanced-topics-and-performance-optimization.html"
        onclick="window.open(this.href, 'facebook-share', 'width=550,height=255');return false;">
        <i class="fa fa-facebook-square fa-lg"></i>
      </a>
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
      <a href="//www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fsungunjo.github.io%2Fjpa-study%2F2022%2F03%2F31%2Fch.15-advanced-topics-and-performance-optimization.html"
        onclick="window.open(this.href, 'linkedin-share', 'width=550,height=255');return false;">
        <i class="fa fa-linkedin-square fa-lg"></i>
      </a>
    
    
    
    
  
    
    
    
    
      <a href="//plus.google.com/share?title=%5B%EC%9E%90%EB%B0%94+ORM+%ED%91%9C%EC%A4%80+JPA+%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D%5D+15%EC%9E%A5.+%EA%B3%A0%EA%B8%89+%EC%A3%BC%EC%A0%9C%EC%99%80+%EC%84%B1%EB%8A%A5+%EC%B5%9C%EC%A0%81%ED%99%94&url=https%3A%2F%2Fsungunjo.github.io%2Fjpa-study%2F2022%2F03%2F31%2Fch.15-advanced-topics-and-performance-optimization.html"
        onclick="window.open(this.href, 'google-plus-share', 'width=550,height=255');return false;">
        <i class="fa fa-google-plus-square fa-lg"></i>
      </a>
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
      <a href="//www.pinterest.com/pin/create/button/?description=%5B%EC%9E%90%EB%B0%94+ORM+%ED%91%9C%EC%A4%80+JPA+%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D%5D+15%EC%9E%A5.+%EA%B3%A0%EA%B8%89+%EC%A3%BC%EC%A0%9C%EC%99%80+%EC%84%B1%EB%8A%A5+%EC%B5%9C%EC%A0%81%ED%99%94&url=https%3A%2F%2Fsungunjo.github.io%2Fjpa-study%2F2022%2F03%2F31%2Fch.15-advanced-topics-and-performance-optimization.html&media=https://sungunjo.github.io/assets/instacode.png"
        onclick="window.open(this.href, 'pinterest-share', 'width=550,height=255');return false;">
        <i class="fa fa-pinterest-square fa-lg"></i>
      </a>
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
      <a href="//www.reddit.com/submit" onclick="window.location = '//www.reddit.com/submit?url=' + encodeURIComponent('https://sungunjo.github.io/jpa-study/2022/03/31/ch.15-advanced-topics-and-performance-optimization.html') + '&title=[자바 ORM 표준 JPA 프로그래밍] 15장. 고급 주제와 성능 최적화'; return false">
        <i class="fa fa-reddit-square fa-lg"></i>
      </a>
    
    
  
    
    
    
    
    
    
    
    
  
</section>




<section class="disqus">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_shortname = 'sungunjo-github-io';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>



</div>
</div>

    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h3 class="footer-heading">Development Stash</h3>

    <div class="site-navigation">

      <p><strong>Site Map</strong></p>
      <ul class="pages">
				
	
	<li class="nav-link"><a href="/about/">About</a>
	

	

	

	
	<li class="nav-link"><a href="/posts/">Posts</a>
	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	


      </ul>
    </div>

    <div class="site-contact">

      <p><strong>Contact</strong></p>
      <ul class="social-media-list">
        <li>
          <a href="mailto:sungunjo.dev@gmail.com">
            <i class="fa fa-envelope-o"></i>
            <span class="username">sungunjo.dev@gmail.com</span>
          </a>
        </li>

        
          
        
          
        
          
          <li>
            <a href="https://github.com/sungunjo" title="Fork me on GitHub">
              <i class="fa fa-github"></i>
              <span class="username">sungunjo</span>
            </a>
          </li>
          
        
          
          <li>
            <a href="https://www.linkedin.com/in/sungunjo" title="Connect with me on LinkedIn">
              <i class="fa fa-linkedin"></i>
              <span class="username">SungUn Jo</span>
            </a>
          </li>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        

      </ul>
    </div>

    <div class="site-signature">
      <p class="rss-subscribe text"><strong>Subscribe <a href="/feed.xml">via RSS</a></strong></p>
      <p class="text">개발 공부 블로그</p>
    </div>

  </div>

</footer>

<!-- Scripts -->
<script src="//code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/highlight.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.1/js/lightbox.min.js"></script>
<script src="//unpkg.com/popper.js@1"></script>
<script src="//unpkg.com/tippy.js@5"></script>

<script type="text/javascript">
$(document).ready(function() {
  // Default syntax highlighting
  hljs.initHighlightingOnLoad();

  // Header
  var menuToggle = $('#js-mobile-menu').unbind();
  $('#js-navigation-menu').removeClass("show");
  menuToggle.on('click', function(e) {
    e.preventDefault();
    $('#js-navigation-menu').slideToggle(function(){
      if($('#js-navigation-menu').is(':hidden')) {
        $('#js-navigation-menu').removeAttr('style');
      }
    });
  });

	// Enable tooltips via Tippy.js
	if (Array.isArray(window.tooltips)) {
		window.tooltips.forEach(function(tooltip) {
			var selector = tooltip[0];
			var config = tooltip[1];
			tippy(selector, config);
		})
	}
});

</script>




<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-156645046-1', 'auto');
  ga('send', 'pageview', {
    'page': '/jpa-study/2022/03/31/ch.15-advanced-topics-and-performance-optimization.html',
    'title': '[자바 ORM 표준 JPA 프로그래밍] 15장. 고급 주제와 성능 최적화'
  });
</script>



  </body>

</html>
